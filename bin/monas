#!/bin/bash
# bin/monas - Claude agent orchestration tool
set -euo pipefail

MONAS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
COMMAND="${1:-}"
shift || true

usage() {
  echo "Usage: monas <command> [options]"
  echo "Commands:"
  echo "  owner                    Start an interactive Claude session as Owner"
  echo "  leader -- <instruction>  Start Leader and spawn members"
  echo "  status                   Show the latest run status"
  echo "  logs [member_name]       Tail logs for leader or specific member"
}

case "$COMMAND" in
  owner)
    exec claude --append-system-prompt "$(cat "$MONAS_DIR/prompts/owner.md")"
    ;;
  leader)
    if [ "${1:-}" = "--" ]; then
      shift
      INSTRUCTION="$*"
      bash "$MONAS_DIR/scripts/run-leader.sh" "$MONAS_DIR" "$INSTRUCTION"
    else
      usage
      exit 1
    fi
    ;;
  status)
    WORKSPACE="$(pwd)/.monas/latest"
    if [ ! -L "$WORKSPACE" ]; then
      echo "No active workspace. Run 'monas leader -- ...' first."
      exit 1
    fi
    # shellcheck source=scripts/json_helpers.sh
    source "$MONAS_DIR/scripts/json_helpers.sh"
    echo "=== Run: $(readlink "$WORKSPACE" | xargs basename) ==="
    if ! err=$(verify_json_syntax "$WORKSPACE/tasks.json"); then
      echo "ERROR: tasks.json is not valid JSON. Phase 1 may have failed."
      echo "Run 'monas logs' to see the leader log for details."
      exit 1
    fi
    jq . "$WORKSPACE/tasks.json"

    # 全タスク完了かつサマリー未生成の場合、遅延生成（冪等）
    # _thoughtフィールドはタスクではないため除外する
    ALL_DONE=$(jq '[to_entries[] | select(.key != "_thought") | .value.status] | all(. == "done" or . == "error")' "$WORKSPACE/tasks.json")
    SUMMARY_FILE="$WORKSPACE/summary.txt"
    if [ "$ALL_DONE" = "true" ] && [ ! -f "$SUMMARY_FILE" ]; then
      echo ""
      echo "All tasks complete. Generating summary..."
      claude -p "全タスクが完了しました。tasks.jsonの内容を基に、達成内容を簡潔にまとめてください。" \
        --append-system-prompt "$(cat "$MONAS_DIR/prompts/leader-summary.md")" \
        --allowedTools "Read" < "$WORKSPACE/tasks.json" > "$SUMMARY_FILE"
      echo ""
      echo "=== Summary ==="
      cat "$SUMMARY_FILE"
    elif [ -f "$SUMMARY_FILE" ]; then
      echo ""
      echo "=== Summary ==="
      cat "$SUMMARY_FILE"
    fi
    ;;
  logs)
    WORKSPACE="$(pwd)/.monas/latest"
    NAME="${1:-}"
    if [ -n "$NAME" ]; then
      LOG_FILE="$WORKSPACE/logs/member-${NAME}.log"
      if [ ! -f "$LOG_FILE" ]; then
        echo "Log file not found: $LOG_FILE"
        if grep -q "FATAL" "$WORKSPACE/logs/leader.log" 2>/dev/null; then
          echo "Phase 1 failed. Members were not started. Check 'monas logs' for details."
        else
          echo "Member '$NAME' may not have been started yet."
        fi
        exit 1
      fi
      tail -f "$LOG_FILE"
    else
      tail -f "$WORKSPACE/logs/leader.log"
    fi
    ;;
  *)
    usage
    exit 1
    ;;
esac
