# ADR-001: ヘッドレスエージェント実行方式の採用

- **日付**: 2026-02-22
- **ステータス**: Accepted

## コンテキスト

ローカル開発環境（Ghostty + Neovim）でClaudeのマルチエージェントオーケストレーションを実現したい。

従来の手法として、tmuxを用いたペイン分割でエージェントごとにUIを持つ方式がよく使われる（参考: multi-agent-shogun）。しかしこれは以下の問題を引き起こす：

- ターミナルエミュレータ・tmux・TUI（Neovim等）間でキーバインドが衝突する
- クリップボードのyank挙動が不安定になる
- コアの開発体験（Neovimでのコーディング）が著しく損なわれる

また、ユーザーの洞察として「Owner以外（Leader, Member）のUIは不要であり、部下に対する関心は『スタックしていないか』『暴走していないか』という可観測性の担保に尽きる」という結論に至った。

## 決定

- **Owner**: UIつきの通常Claudeセッション（インタラクティブ）。ユーザーとの唯一の窓口。
- **Leader / Member**: `claude -p`（ヘッドレスモード）でバックグラウンドプロセスとして実行。UIを持たない。

`claude -p` の主な特性：
- stdoutに結果を出力する（`--output-format json` でメタデータ付きJSON）
- stdinからプロンプトをパイプ可能
- `--allowedTools` でツール権限を制限
- `--append-system-prompt` でプロンプトをカスタマイズ
- バックグラウンドで実行し、`> logfile 2>&1 &` でログをファイルに分離できる

## 理由

- **UI衝突の完全な排除**: OwnerのClaudeセッション（Ghostty内のNeovim隣）のみがUIを持ち、他は完全にバックグラウンド
- **可観測性の確保**: 全出力はログファイル（`.monas/<RUNID>/logs/`）に隔離され、`tail -f` または `monas logs` でいつでも監査可能
- **既存ツールチェーンの保護**: Neovim等のTUIを一切妨害しない

## 結果

- LeaderとMemberはUIを持たないため、「進捗確認」はOwnerがログファイルを読んで代行する
- Ownerはバックグラウンドプロセスの完了を自動検知しない。ユーザーから聞かれたときにOwnerがログを読んで報告する
- `claude -p` の実行コストはインタラクティブモードと同じ（APIコスト）
