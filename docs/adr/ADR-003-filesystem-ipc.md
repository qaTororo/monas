# ADR-003: ファイルシステムを唯一のエージェント間通信手段とする

- **日付**: 2026-02-22
- **ステータス**: Accepted

## コンテキスト

マルチエージェントシステムでは、エージェント間の状態共有と通信手段の設計が重要になる。主な選択肢：

1. **インプロセス共有メモリ**: 同一プロセス内のみ有効。プロセス分離の場合は使えない
2. **ソケット/パイプによるIPC**: リアルタイム通信が可能だが、プロセス生存中のみ有効
3. **データベース（SQLite等）**: 永続化・クエリが可能だが、追加依存が発生
4. **ファイルシステム（JSON）**: 永続的、監査可能、ツール不要

## 決定

エージェント間の全通信を `tasks.json` を介した非同期ファイルシステムI/Oで行う。インメモリのIPCは一切行わない。

**tasks.jsonのスキーマ**:
```json
{
  "TASK_NAME": {
    "objective": "Memberが達成すべきこと",
    "definition_of_done": ["条件1", "条件2"],
    "allowed_tools": ["Read", "Edit"],
    "status": "in_progress",
    "final_report": ""
  }
}
```

`status` フィールドが唯一の通信チャネル:
- `in_progress`: Memberが作業中
- `done`: Memberが完了（`final_report` に結果）
- `error`: サーキットブレーカーが発動

排他制御は `mkdir` のアトミック性を利用したスピンロックで実現（ADR-004参照）。

## 理由

**ステートレス実行（Ralph Loop原則）**:
- 各 `claude -p` の呼び出しは完全に独立した新しいコンテキスト
- 状態はファイルシステムに永続化されるため、プロセス再起動後も状態を復元できる

**可観測性**:
- `tasks.json` はいつでも `monas status` や `jq` で直接確認できる
- 監査ログ（`logs/*.log`）も同じワークスペースに保存される

**シンプルさ**:
- 追加インフラ（メッセージキュー、データベース）が不要
- Owner（インタラクティブClaude）が `tasks.json` をReadツールで直接読んで進捗を報告できる

## 結果

- エージェント間通信はファイルシステムI/Oのレイテンシに依存する（通常は無視できる）
- Leader終了後も `tasks.json` が残るため、事後確認が可能
- 複数の並列Memberが同時に書き込む場合は排他制御が必要（ADR-004で対応）
- Ownerへの完了通知は自動ではなく、ユーザーが確認を求めたときにOwnerがログを読む設計
