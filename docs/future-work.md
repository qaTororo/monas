# Future Work

現在のKISS/YAGNI原則に基づくミニマルな構成を維持しつつ、スケール時のリスクに備えた改善計画。

---

## 1. トークン長（コンテキスト）の肥大化対策

**現状の課題**:
Ralph Loopにおいて `context-${MEMBER}.txt` に毎回の実行結果を追記していくため、イテレーションを重ねるごとにプロンプトのトークン数が線形増大する。APIコストの急増、レスポンス遅延、最終的にはコンテキストウィンドウ上限到達（Token Limit Exceeded）によるクラッシュを引き起こす。

**対策方針（選択肢）**:

- **A. スライディングウィンドウ**: 直近N回分のイテレーションログのみを保持し、古いログは `tail -n` 等で破棄する（bashで容易に実装可能）
- **B. 動的要約（TL;DR圧縮）**: ログファイルが一定サイズを超えた場合、軽量なプロンプトを用いて「これまでの実行履歴の要約」を生成し、ログを圧縮して置き換える機構を導入する

---

## 2. フォールトトレランスと監視機構（スタック検知）

**現状の課題**:
MemberのLLMが同じ思考の誤謬（ハルシネーション）に陥り、全く同じコマンドを打って同じエラーを繰り返す「スタック状態」に陥った場合、サーキットブレーカー（MAX_ITER）まで計算リソースを浪費する。

**対策方針（アクターモデルのスーパーバイザーツリー）**:
Erlang/OTPのアクターモデルにおける「親が子を監視し、異常時は再起動または人間にエスカレーションする」概念を参考に、Memberのループ内に以下を追加する：

- 直近の出力が前回の出力と同一（または極めて類似）かを判定（出力のハッシュ値比較）
- 同一エラーの反復を検知した場合はループを早期 `break`
- `tasks.json` のステータスを `stuck` や `needs_help` に変更してOwnerの介入を促す

**実装済み**:

- `scripts/member-loop.sh`: `sha256sum` による直前イテレーション出力のハッシュ比較を実装。連続2回一致（同一出力）を検知した場合に early `break` を実行し、`tasks.json` の当該タスクの `status` を `stuck` に更新する
- `bin/monas`: ALL_DONE 判定に `stuck` ステータスを追加（`done` または `error` または `stuck` で全完了とみなす）。完了時に `stuck` タスクが存在する場合は警告メッセージを表示する

---

## 3. セキュリティと実行権限の制約（最小権限の原則）

**現状の課題**:
MemberへのBashツール付与は、エージェントにローカル環境のフルアクセスに近い権限を与えることを意味する。プロンプトインジェクションやLLMの暴走により、破壊的なコマンドが実行されるリスクがある。

**対策方針**:

- **実行環境の隔離**: Memberプロセスの作業ディレクトリをDockerコンテナ等のサンドボックス環境内にマウントして実行
- **コマンドのホワイトリスト化**: `allowedTools` のBash制約をより細かく制御（例: `Bash(npm *)` で `npm` コマンドのみ許可）。Claude Code CLIの権限設定の最新仕様を追従し、常にLeast Privilegeを維持する

---

## 4. リーダープロセスのレジリエンス（ステートレス実行の完成）

**現状の課題**:
`run-leader.sh` は `wait` コマンドでMemberプロセスを同期的に待機している。Leaderプロセスが（端末を閉じる等で）SIGKILLされた場合、以下の問題が発生する：

- バックグラウンドのMemberが孤児プロセス（Orphan）になる
- LeaderのPhase 3（サマリー生成）が実行されず全体が宙に浮く

**対策方針（ステートレス化）**:
状態管理を完全に `tasks.json` に倒し、Leaderプロセス自身もステートレスにする：

- `run-leader.sh` はMemberをkickした直後に終了
- タスクの完了確認とサマリー生成は `monas status` を叩いたタイミングで行う
- または別の軽量な監視デーモンが `tasks.json` をポーリングする形へのリファクタリング

**実装済み**:

- `run-leader.sh`: `setsid`（フォールバック: `nohup + disown`）による独立セッション起動。`wait` とPhase 3（サマリー生成）を削除しLeaderをステートレス化
- `monas status`: 全タスク完了時の遅延サマリー生成を追加。`summary.txt` に保存し冪等性を確保（何度叩いても再生成しない）
